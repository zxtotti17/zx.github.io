{"title":"游戏全局通知红点系统","slug":"游戏全局通知红点系统","date":"2019-08-23T09:44:00.000Z","updated":"2019-11-27T15:26:48.000Z","comments":true,"path":"api/articles/游戏全局通知红点系统.json","photos":[],"link":"","excerpt":null,"covers":["Red15669620461084.png"],"content":"<p>红点功能贯穿游戏所有功能，像是一个全局的通知，用一个配置表记录所有游戏功能及入口和红点、开启的方法名加载进内存<br><img src=\"Red15669620461084.png\" alt=\"Red15669620461084\"><br>主入口界面时候调用<br>取得已开启的功能列表mod_function:get_all_game_function() 构造成带父子关系的功能列表<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;Id,[&#123;GameFunction <span class=\"comment\">#game_function.id&#125;|List1]&#125;</span></span><br><span class=\"line\">|</span><br><span class=\"line\">lists:delete(&#123;Id,List1&#125;,L)</span><br></pre></td></tr></table></figure></p>\n<p>通过核心回调到所有模块的红点方法<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IsRed = <span class=\"keyword\">if</span></span><br><span class=\"line\">    Mod =/= <span class=\"string\">''</span>, Func =/= <span class=\"string\">''</span> -&gt;</span><br><span class=\"line\">        try erlang:apply(Mod,Func,[PlayerId]) of</span><br><span class=\"line\">            Result -&gt;</span><br><span class=\"line\">                Result</span><br><span class=\"line\">        catch</span><br><span class=\"line\">            _ : _ -&gt;</span><br><span class=\"line\">                <span class=\"literal\">false</span></span><br><span class=\"line\">        end;</span><br><span class=\"line\">    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">        <span class=\"literal\">false</span></span><br><span class=\"line\">end,</span><br></pre></td></tr></table></figure></p>\n<p>最后将缓存中的玩家红点数据替换<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib_ets:delete(player_red, PlayerId),</span><br><span class=\"line\">    lib_ets:insert(</span><br><span class=\"line\">        player_red,</span><br><span class=\"line\">        <span class=\"comment\">#player_red&#123;</span></span><br><span class=\"line\">            player_id = PlayerId,</span><br><span class=\"line\">            red_list  = N</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        replace</span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>不同的功能触发红点改变需要有个打点的函数,在功能需要改变红点状态的时候通知进来更新缓存<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">notify_game_function_is_red (PlayerId,FunctionId) -&gt;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> mod_function:check_lock(PlayerId,FunctionId) of</span><br><span class=\"line\">        <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">            noop;</span><br><span class=\"line\">        _ -&gt;</span><br><span class=\"line\">            GameFunction = code_db:get(game_function,[FunctionId]),</span><br><span class=\"line\">            Mod   = list_to_atom(GameFunction <span class=\"comment\">#game_function.red_mod),</span></span><br><span class=\"line\">            Func  = list_to_atom(GameFunction <span class=\"comment\">#game_function.red_func),</span></span><br><span class=\"line\">            IsRed = <span class=\"keyword\">if</span></span><br><span class=\"line\">                Mod =/= <span class=\"string\">''</span>, Func =/= <span class=\"string\">''</span> -&gt;</span><br><span class=\"line\">                   try erlang:apply(Mod,Func,[PlayerId]) of</span><br><span class=\"line\">                        Result -&gt;</span><br><span class=\"line\">                            Result</span><br><span class=\"line\">                    catch</span><br><span class=\"line\">                        _ : _ -&gt;</span><br><span class=\"line\">                            <span class=\"literal\">false</span></span><br><span class=\"line\">                    end;</span><br><span class=\"line\">                <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                    <span class=\"literal\">false</span></span><br><span class=\"line\">            end,</span><br><span class=\"line\">            <span class=\"keyword\">if</span></span><br><span class=\"line\">                GameFunction <span class=\"comment\">#game_function.relation &gt; 0 -&gt;</span></span><br><span class=\"line\">                    notify_relation_game_function_is_red(PlayerId,GameFunction <span class=\"comment\">#game_function.relation,FunctionId,IsRed);%通知父类联动的函数</span></span><br><span class=\"line\">                <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                    update_game_function_cache(PlayerId,FunctionId,IsRed)</span><br><span class=\"line\">            end</span><br><span class=\"line\">    end.</span><br></pre></td></tr></table></figure></p>\n","categories":[],"tags":[{"name":"游戏","slug":"游戏","count":3,"path":"api/tags/游戏.json"}]}