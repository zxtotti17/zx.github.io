{"title":"游戏中大型自动比赛玩法设计","slug":"游戏中大型比赛玩法设计思路","date":"2019-07-30T08:08:45.000Z","updated":"2019-11-27T15:26:48.000Z","comments":true,"path":"api/articles/游戏中大型比赛玩法设计思路.json","photos":[],"link":"","excerpt":"争霸赛赛程范例<br>3月1日 0：00~3月3日 12:00    报名    40级以上手动报名<br>3月3日 13：00    淘汰赛    “13:00取数据，提前1小时向玩家发送邮件提醒<br>13:10开始出战报，每隔5分钟出1场战报<br>天榜负5局进入地榜，地榜负5局则被淘汰”<br>3月4日 14:00    16强赛（32进16）    “每小时1局，每局取1次数据，5局3胜制<br>天地榜同时进行<br>比赛开始前1小时向玩家发送邮件提醒取数据制度”<br>3月5日 14:00    16进8<br>3月6日 14:00    8进4<br>3月7日 14:00    半决赛<br>3月8日 14:00    决赛<br>3月8日 决赛全部结束    统一发放奖励    比赛的时间控制由单独时间进程来控制时间的推进，相当于php中的crontab,表结构上一个玩家比赛进程表player_race,<br>一个各阶段玩家成员信息表player_race_member，后期系统匹配各阶段玩家匹配信息表player_race_opponent，<br>一个各阶段玩家战报信息表player_race_report，一个各阶段玩家结果表player_race_result，<br>玩家表可以分为  玩家比赛信息表  player_st_jjc_race 玩家匹配信息表 player_st_jjc_race_opponent 玩家日志表 player_st_jjc_race_score_log第一步 报名<br>很简单直接报名请求记录玩家数据就行,报名时间结束时触发事件对所有玩家进行匹配<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>case try_get_player_server_war(PlayerId) of<br>    null -&gt;<br>        Tran = fun() -&gt;<br>            game_db:write(#player_server_war &#123;<br>                player_id  = PlayerId, <br>                apply_time = lib_misc:get_local_timestamp()<br>            &#125;)<br>            % mod_deploy:get(PlayerId, ?RACE_SERVER_WAR)<br>        end, <br>        game_db:do(Tran);<br>    _ -&gt;<br>        exit(already_apply)<br>end.<br><br>% 本服报名结束手机玩家数据<br>apply_over() -&gt;<br>    List = get_all_player_server_war(),<br>    Tran = fun() -&gt;<br>        lists:foreach(<br>            fun(Rec) -&gt;<br>                game_db:write(Rec #player_server_war &#123;<br>                    race_step = ?RS_TIAN_BANG_TAOTAI<br>                &#125;)<br>            end, <br>            List<br>        )<br>    end,<br>    game_db:do(Tran),<br>    ?INFO(\"apply_over\",[]),<br>    ZoneList = lists:foldl(<br>        fun(PlayerServerWar, R) -&gt;<br>            [PlayerServerWar #player_server_war.player_id | R]<br>        end,<br>        [],<br>        get_all_player_server_war()<br>    ),<br><br>    mod_race:init_race_member(<br>       ?RACE_SERVER_WAR,<br>       0,<br>       ?RS_TIAN_BANG_TAOTAI,<br>       0,<br>       ZoneList,<br>       normal<br>    ).<br>注意的是用一个单独的进程来管理活动步骤开启结束<br> [Figure] ","covers":["Er15646489002180.png","Er15646493808263.png","Er15647120482687.png","Er15647145661718.png"],"content":"<p>争霸赛赛程范例<br>3月1日 0：00~3月3日 12:00    报名    40级以上手动报名<br>3月3日 13：00    淘汰赛    “13:00取数据，提前1小时向玩家发送邮件提醒<br>13:10开始出战报，每隔5分钟出1场战报<br>天榜负5局进入地榜，地榜负5局则被淘汰”<br>3月4日 14:00    16强赛（32进16）    “每小时1局，每局取1次数据，5局3胜制<br>天地榜同时进行<br>比赛开始前1小时向玩家发送邮件提醒取数据制度”<br>3月5日 14:00    16进8<br>3月6日 14:00    8进4<br>3月7日 14:00    半决赛<br>3月8日 14:00    决赛<br>3月8日 决赛全部结束    统一发放奖励    </p>\n<p>比赛的时间控制由单独时间进程来控制时间的推进，相当于php中的crontab,表结构上一个玩家比赛进程表player_race,<br>一个各阶段玩家成员信息表player_race_member，后期系统匹配各阶段玩家匹配信息表player_race_opponent，<br>一个各阶段玩家战报信息表player_race_report，一个各阶段玩家结果表player_race_result，<br>玩家表可以分为  玩家比赛信息表  player_st_jjc_race 玩家匹配信息表 player_st_jjc_race_opponent 玩家日志表 player_st_jjc_race_score_log</p>\n<p>第一步 报名<br>很简单直接报名请求记录玩家数据就行,报名时间结束时触发事件对所有玩家进行匹配<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">case</span> try_get_player_server_war(PlayerId) of</span><br><span class=\"line\">    null -&gt;</span><br><span class=\"line\">        Tran = fun() -&gt;</span><br><span class=\"line\">            game_db:write(<span class=\"comment\">#player_server_war &#123;</span></span><br><span class=\"line\">                player_id  = PlayerId, </span><br><span class=\"line\">                apply_time = lib_misc:get_local_timestamp()</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">            % mod_deploy:get(PlayerId, ?RACE_SERVER_WAR)</span><br><span class=\"line\">        end, </span><br><span class=\"line\">        game_db:<span class=\"keyword\">do</span>(Tran);</span><br><span class=\"line\">    _ -&gt;</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(already_apply)</span><br><span class=\"line\">end.</span><br><span class=\"line\"></span><br><span class=\"line\">% 本服报名结束手机玩家数据</span><br><span class=\"line\">apply_over() -&gt;</span><br><span class=\"line\">    List = get_all_player_server_war(),</span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        lists:foreach(</span><br><span class=\"line\">            fun(Rec) -&gt;</span><br><span class=\"line\">                game_db:write(Rec <span class=\"comment\">#player_server_war &#123;</span></span><br><span class=\"line\">                    race_step = ?RS_TIAN_BANG_TAOTAI</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">            end, </span><br><span class=\"line\">            List</span><br><span class=\"line\">        )</span><br><span class=\"line\">    end,</span><br><span class=\"line\">    game_db:<span class=\"keyword\">do</span>(Tran),</span><br><span class=\"line\">    ?INFO(<span class=\"string\">\"apply_over\"</span>,[]),</span><br><span class=\"line\">    ZoneList = lists:foldl(</span><br><span class=\"line\">        fun(PlayerServerWar, R) -&gt;</span><br><span class=\"line\">            [PlayerServerWar <span class=\"comment\">#player_server_war.player_id | R]</span></span><br><span class=\"line\">        end,</span><br><span class=\"line\">        [],</span><br><span class=\"line\">        get_all_player_server_war()</span><br><span class=\"line\">    ),</span><br><span class=\"line\"></span><br><span class=\"line\">    mod_race:init_race_member(</span><br><span class=\"line\">       ?RACE_SERVER_WAR,</span><br><span class=\"line\">       0,</span><br><span class=\"line\">       ?RS_TIAN_BANG_TAOTAI,</span><br><span class=\"line\">       0,</span><br><span class=\"line\">       ZoneList,</span><br><span class=\"line\">       normal</span><br><span class=\"line\">    ).</span><br></pre></td></tr></table></figure></p>\n<p>注意的是用一个单独的进程来管理活动步骤开启结束<br><img src=\"Er15646489002180.png\" alt=\"Er15646489002180\"><br><a id=\"more\"></a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">% 每一个活动开始所要做的处理</span><br><span class=\"line\">activity_start (ActivityId) -&gt;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> mod_server:is_game_server() of</span><br><span class=\"line\">        <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">            xdh_race_srv:activity_start(ActivityId);</span><br><span class=\"line\">        <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> mod_server:is_cc_server() of</span><br><span class=\"line\">                <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                    % cc_server_war_cron_srv:activity_start(Id);</span><br><span class=\"line\">                    noop;</span><br><span class=\"line\">                <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">                    noop</span><br><span class=\"line\">            end</span><br><span class=\"line\">    end.</span><br><span class=\"line\"></span><br><span class=\"line\">% 每一个活动结束所要做的处理</span><br><span class=\"line\">activity_stop (ActivityId) -&gt;</span><br><span class=\"line\">   <span class=\"keyword\">case</span> mod_server:is_game_server() of</span><br><span class=\"line\">        <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">            xdh_race_srv:activity_stop(ActivityId);</span><br><span class=\"line\">        <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> mod_server:is_cc_server() of</span><br><span class=\"line\">                <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                    % cc_server_war_cron_srv:activity_stop(Id);</span><br><span class=\"line\">                    noop;</span><br><span class=\"line\">                <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">                    noop</span><br><span class=\"line\">            end</span><br><span class=\"line\">    end.</span><br></pre></td></tr></table></figure></p>\n<p>在到点时间的相应上做特殊处理</p>\n<p>第二步 开启淘汰赛<br>淘汰赛的开启同样用时间进程来控制，到点后调用启动方法<br><img src=\"Er15646493808263.png\" alt=\"Er15646493808263\"> （判断结束 、清上一轮数据）<br>淘汰赛相当于一个递归的过程，全服玩家进行了一场比赛后记录玩家信息及淘汰结果直到淘汰赛结束的条件,同时需要一个全服步骤数据记录，然后循环比赛<br>其中每一轮淘汰赛可分为 判断结束 、清上一轮数据 、不重复随机匹配 、 战斗及数据记录 、 循环<br><img src=\"Er15647109579023.png\" alt=\"Er15647109579023\"> （不重复随机匹配 循环）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- 战斗部分及记录 --&gt;</span><br><span class=\"line\">race_fight (RaceId, ZoneId, RaceStep, TeamIdA, TeamIdB) -&gt;</span><br><span class=\"line\">    <span class=\"comment\">#player_race &#123;</span></span><br><span class=\"line\">        race_times = RaceTimes</span><br><span class=\"line\">    &#125; = get_player_race(RaceId, ZoneId), </span><br><span class=\"line\"></span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> race_call(RaceId, fight, [RaceStep, TeamIdA, TeamIdB]) of</span><br><span class=\"line\">            [] -&gt;</span><br><span class=\"line\">                <span class=\"built_in\">exit</span>(&#123;invalid_fight, RaceId, TeamIdA, TeamIdB&#125;);</span><br><span class=\"line\">            ReportList -&gt;</span><br><span class=\"line\">                &#123;_, WinTeamId&#125; = lists:foldr(</span><br><span class=\"line\">                    fun(Report, &#123;NowIndex, NowWinTeamId&#125;) -&gt;</span><br><span class=\"line\">                        <span class=\"comment\">#war_result &#123;</span></span><br><span class=\"line\">                            winner       = &#123;_, WinnerId&#125;, </span><br><span class=\"line\">                            army_result1 = <span class=\"comment\">#army_result &#123;</span></span><br><span class=\"line\">                                army_key = &#123;_, PlayerIdA&#125;</span><br><span class=\"line\">                            &#125;, </span><br><span class=\"line\">                            army_result2 = <span class=\"comment\">#army_result &#123;</span></span><br><span class=\"line\">                                army_key = &#123;_, PlayerIdB&#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; = Report, </span><br><span class=\"line\"></span><br><span class=\"line\">                        NewWinTeamId = <span class=\"keyword\">if</span></span><br><span class=\"line\">                            NowIndex =:= length(ReportList) -&gt;</span><br><span class=\"line\">                                WinTeamId = <span class=\"keyword\">if</span></span><br><span class=\"line\">                                    WinnerId =:= PlayerIdA -&gt;</span><br><span class=\"line\">                                        TeamIdA;</span><br><span class=\"line\">                                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                        TeamIdB</span><br><span class=\"line\">                                end, </span><br><span class=\"line\"></span><br><span class=\"line\">                                game_db:write(<span class=\"comment\">#player_race_result &#123;</span></span><br><span class=\"line\">                                    race_id     = RaceId, </span><br><span class=\"line\">                                    zone_id     = ZoneId, </span><br><span class=\"line\">                                    race_step   = RaceStep, </span><br><span class=\"line\">                                    player_id   = TeamIdA, </span><br><span class=\"line\">                                    player_id1  = TeamIdB, </span><br><span class=\"line\">                                    race_times  = RaceTimes, </span><br><span class=\"line\">                                    version     = ?GET_ENV(vsn, <span class=\"string\">\"\"</span>), </span><br><span class=\"line\">                                    report_time = lib_misc:get_local_timestamp(), </span><br><span class=\"line\">                                    winner_id   = WinTeamId</span><br><span class=\"line\">                                &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                                WinTeamId;</span><br><span class=\"line\">                            <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                NowWinTeamId</span><br><span class=\"line\">                        end, </span><br><span class=\"line\"></span><br><span class=\"line\">                        game_db:write(<span class=\"comment\">#player_race_report &#123;</span></span><br><span class=\"line\">                            race_id     = RaceId, </span><br><span class=\"line\">                            zone_id     = ZoneId, </span><br><span class=\"line\">                            race_step   = RaceStep, </span><br><span class=\"line\">                            player_id   = TeamIdA, </span><br><span class=\"line\">                            race_times  = RaceTimes, </span><br><span class=\"line\">                            index       = NowIndex, </span><br><span class=\"line\">                            attacker_id = PlayerIdA, </span><br><span class=\"line\">                            defender_id = PlayerIdB, </span><br><span class=\"line\">                            winner_id   = WinnerId, </span><br><span class=\"line\">                            report_id   = war_report_srv:record_war_report(Report, 30 * 86400)</span><br><span class=\"line\">                        &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                        &#123;</span><br><span class=\"line\">                            NowIndex - 1, </span><br><span class=\"line\">                            NewWinTeamId</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    end, </span><br><span class=\"line\">                    &#123;length(ReportList), 0&#125;, </span><br><span class=\"line\">                    ReportList</span><br><span class=\"line\">                ), </span><br><span class=\"line\"></span><br><span class=\"line\">                WinTeamId</span><br><span class=\"line\">        end</span><br><span class=\"line\">    end, </span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;atomic, TeamId&#125; = game_db:<span class=\"keyword\">do</span>(Tran), </span><br><span class=\"line\">    TeamId.</span><br></pre></td></tr></table></figure></p>\n<p>在淘汰赛结束后，将剩余晋级玩家进入晋级赛步骤，同时初始化随机匹配<br><img src=\"Er15647120482687.png\" alt=\"Er15647120482687\"><br>一下两种匹配方式<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">init_race_member(RaceId, ZoneId, RaceStep, Group, TeamIdList, normal) -&gt;</span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        lists:foldl(</span><br><span class=\"line\">            fun(TeamId, NowIndex) -&gt;</span><br><span class=\"line\">                game_db:write(<span class=\"comment\">#player_race_member &#123;</span></span><br><span class=\"line\">                    race_id   = RaceId, </span><br><span class=\"line\">                    race_step = RaceStep, </span><br><span class=\"line\">                    zone_id   = ZoneId, </span><br><span class=\"line\">                    group     = Group, </span><br><span class=\"line\">                    index     = NowIndex, </span><br><span class=\"line\">                    player_id = TeamId</span><br><span class=\"line\">                &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                NowIndex + 1</span><br><span class=\"line\">            end, </span><br><span class=\"line\">            1, </span><br><span class=\"line\">            TeamIdList</span><br><span class=\"line\">        )</span><br><span class=\"line\">    end, </span><br><span class=\"line\"></span><br><span class=\"line\">    game_db:<span class=\"keyword\">do</span>(Tran);</span><br><span class=\"line\"></span><br><span class=\"line\">init_race_member(RaceId, ZoneId, RaceStep, Group, TeamIdList, random) -&gt;</span><br><span class=\"line\">    <span class=\"comment\">#race_step &#123;</span></span><br><span class=\"line\">        match_num = MatchNum</span><br><span class=\"line\">    &#125; = get_race_step(RaceStep), </span><br><span class=\"line\"></span><br><span class=\"line\">    Step = get_index_step(length(TeamIdList), MatchNum), </span><br><span class=\"line\"></span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        lists:foldl(</span><br><span class=\"line\">            fun(TeamId, NowIndex) -&gt;</span><br><span class=\"line\">                game_db:write(<span class=\"comment\">#player_race_member &#123;</span></span><br><span class=\"line\">                    race_id   = RaceId, </span><br><span class=\"line\">                    race_step = RaceStep, </span><br><span class=\"line\">                    zone_id   = ZoneId, </span><br><span class=\"line\">                    group     = Group, </span><br><span class=\"line\">                    index     = NowIndex, </span><br><span class=\"line\">                    player_id = TeamId</span><br><span class=\"line\">                &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span></span><br><span class=\"line\">                    NowIndex + Step &gt; MatchNum * 2 -&gt;</span><br><span class=\"line\">                        1 + Step div 2;</span><br><span class=\"line\">                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                        NowIndex + Step</span><br><span class=\"line\">                end</span><br><span class=\"line\">            end, </span><br><span class=\"line\">            1, </span><br><span class=\"line\">            lib_misc:shuffle(TeamIdList)</span><br><span class=\"line\">        )</span><br><span class=\"line\">    end, </span><br><span class=\"line\"></span><br><span class=\"line\">    game_db:<span class=\"keyword\">do</span>(Tran);</span><br></pre></td></tr></table></figure></p>\n<p>第三步 战报<br>战报开启也是进程时间来控制<br><img src=\"Er15647145661718.png\" alt=\"Er15647145661718\"></p>\n<p>第四步 开启晋级赛<br>同样是进程计时器开启，比赛流程除了一局定输赢以外和淘汰赛基本一致，比赛也是一次性打完，战报根据时间慢慢的播放<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">% 开启杯赛</span><br><span class=\"line\">timer_start_race() -&gt;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> mod_server:is_cc_server() of</span><br><span class=\"line\">        <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">            % cc_server_war_cron_srv:start_race(0);</span><br><span class=\"line\">            noop;</span><br><span class=\"line\">        <span class=\"literal\">false</span> -&gt;</span><br><span class=\"line\">            Times = mod_server:get_player_server_int_data(?SDT_SERVER_WAR_RACE_TIMES),</span><br><span class=\"line\">            xdh_race_srv:try_apply(mod_server,set_player_server_int_data,[?SDT_SERVER_WAR_RACE_TIMES,Times + 1]),</span><br><span class=\"line\">            start_race(),</span><br><span class=\"line\">            mod_timer:reset(1, ?TIMER_XIAN_DAO_HUI_BEI_SAI)</span><br><span class=\"line\">    end. </span><br><span class=\"line\"></span><br><span class=\"line\">start_race() -&gt;</span><br><span class=\"line\">    RaceStep    = get_server_war_race_step(), </span><br><span class=\"line\">    PlayerRace  = mod_race:get_player_race(?RACE_SERVER_WAR,0),</span><br><span class=\"line\">    IsOver = <span class=\"keyword\">case</span> mod_race:start_race(?RACE_SERVER_WAR, 0, RaceStep, 3) of</span><br><span class=\"line\">        <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">            <span class=\"literal\">true</span>;</span><br><span class=\"line\">        _ -&gt; </span><br><span class=\"line\">            mod_timer:reset(0, ?TIMER_XIAN_DAO_HUI_BEI_SAI, 3420),</span><br><span class=\"line\">            <span class=\"literal\">false</span></span><br><span class=\"line\">    end,</span><br><span class=\"line\"></span><br><span class=\"line\">    RaceTimes = <span class=\"keyword\">if</span></span><br><span class=\"line\">        RaceStep =/= PlayerRace <span class=\"comment\">#player_race.race_step -&gt;</span></span><br><span class=\"line\">            1;</span><br><span class=\"line\">        <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">            PlayerRace <span class=\"comment\">#player_race.race_times + 1</span></span><br><span class=\"line\">    end,</span><br><span class=\"line\">    xdh_race_srv:try_apply(mod_server,set_player_server_int_data,[?SDT_SERVER_WAR_RACE_TIMES,RaceTimes]),</span><br><span class=\"line\">    deal_receive_beisai_data(RaceStep,IsOver).</span><br></pre></td></tr></table></figure></p>\n<p>战斗部分基本一致多一个匹配结果记录表<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start_race(RaceId, ZoneId, RaceStep, WinTimes) -&gt;</span><br><span class=\"line\">    <span class=\"comment\">#race_step &#123;</span></span><br><span class=\"line\">        match_num = MatchNum, </span><br><span class=\"line\">        next_race = NextRace, </span><br><span class=\"line\">        next_step = NextStep</span><br><span class=\"line\">    &#125; = get_race_step(RaceStep), </span><br><span class=\"line\"></span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        PlayerRace = get_player_race(RaceId, ZoneId), </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span></span><br><span class=\"line\">            PlayerRace <span class=\"comment\">#player_race.race_step =:= RaceStep,</span></span><br><span class=\"line\">                PlayerRace <span class=\"comment\">#player_race.race_times =/= 0 -&gt;</span></span><br><span class=\"line\">                <span class=\"keyword\">case</span> check_race_over(RaceId, ZoneId, RaceStep) of</span><br><span class=\"line\">                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                        <span class=\"built_in\">exit</span>(race_over);</span><br><span class=\"line\">                    _ -&gt;</span><br><span class=\"line\">                        noop</span><br><span class=\"line\">                end, </span><br><span class=\"line\"></span><br><span class=\"line\">                game_db:write(PlayerRace <span class=\"comment\">#player_race &#123;</span></span><br><span class=\"line\">                    race_times = PlayerRace <span class=\"comment\">#player_race.race_times + 1, </span></span><br><span class=\"line\">                    last_time  = lib_misc:get_local_timestamp()</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                clear_race_data(RaceId, ZoneId, RaceStep), </span><br><span class=\"line\">                init_race_opponent(RaceId, ZoneId, RaceStep), </span><br><span class=\"line\"></span><br><span class=\"line\">                game_db:write(PlayerRace <span class=\"comment\">#player_race &#123;</span></span><br><span class=\"line\">                    race_step  = RaceStep, </span><br><span class=\"line\">                    race_times = 1, </span><br><span class=\"line\">                    last_time  = lib_misc:get_local_timestamp(), </span><br><span class=\"line\">                    win_times  = WinTimes</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">        end, </span><br><span class=\"line\"></span><br><span class=\"line\">        lists:foreach(</span><br><span class=\"line\">            fun(Group) -&gt;</span><br><span class=\"line\">                lists:foreach(</span><br><span class=\"line\">                    fun(Index) -&gt;</span><br><span class=\"line\">                        RaceMemberA = try_get_player_race_member(RaceId, ZoneId, RaceStep, Group, Index * 2 - 1), </span><br><span class=\"line\">                        RaceMemberB = try_get_player_race_member(RaceId, ZoneId, RaceStep, Group, Index * 2), </span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span></span><br><span class=\"line\">                            RaceMemberA =:= null, RaceMemberB =:= null -&gt;</span><br><span class=\"line\">                                noop;</span><br><span class=\"line\">                            %%轮空为全空或者B为空</span><br><span class=\"line\">                            % RaceMemberA =:= null -&gt;</span><br><span class=\"line\">                            %     game_db:write(<span class=\"comment\">#player_race_member &#123;</span></span><br><span class=\"line\">                            %         race_id   = RaceId, </span><br><span class=\"line\">                            %         race_step = NextRace, </span><br><span class=\"line\">                            %         group     = Group, </span><br><span class=\"line\">                            %         index     = Index, </span><br><span class=\"line\">                            %         player_id = RaceMemberB <span class=\"comment\">#player_race_member.player_id</span></span><br><span class=\"line\">                            %     &#125;);</span><br><span class=\"line\">                            RaceMemberB =:= null -&gt;</span><br><span class=\"line\">                                TeamIdA  = RaceMemberA <span class=\"comment\">#player_race_member.player_id, </span></span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">case</span> check_opponent_over(RaceId, ZoneId, RaceStep, TeamIdA) of</span><br><span class=\"line\">                                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                        noop;</span><br><span class=\"line\">                                    _ -&gt;</span><br><span class=\"line\">                                        Opponent = try_get_player_race_opponent(RaceId, ZoneId, RaceStep, TeamIdA), </span><br><span class=\"line\"></span><br><span class=\"line\">                                        game_db:write(Opponent <span class=\"comment\">#player_race_opponent &#123;</span></span><br><span class=\"line\">                                            winner_id = TeamIdA</span><br><span class=\"line\">                                        &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                                        game_db:write(<span class=\"comment\">#player_race_member &#123;</span></span><br><span class=\"line\">                                            race_id   = RaceId,</span><br><span class=\"line\">                                            zone_id   = ZoneId, </span><br><span class=\"line\">                                            race_step = NextRace, </span><br><span class=\"line\">                                            group     = Group, </span><br><span class=\"line\">                                            index     = Index, </span><br><span class=\"line\">                                            player_id = TeamIdA</span><br><span class=\"line\">                                        &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                                        race_call(RaceId, race_win, [TeamIdA, Group, RaceStep, NextRace])</span><br><span class=\"line\">                                end;</span><br><span class=\"line\">                            <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                TeamIdA = RaceMemberA <span class=\"comment\">#player_race_member.player_id, </span></span><br><span class=\"line\">                                TeamIdB = RaceMemberB <span class=\"comment\">#player_race_member.player_id, </span></span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">case</span> check_opponent_over(RaceId, ZoneId, RaceStep, TeamIdA) of</span><br><span class=\"line\">                                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                        noop;</span><br><span class=\"line\">                                    _ -&gt;</span><br><span class=\"line\">                                        <span class=\"keyword\">case</span> race_fight(RaceId, ZoneId, RaceStep, TeamIdA, TeamIdB) of</span><br><span class=\"line\">                                            0 -&gt;</span><br><span class=\"line\">                                                noop;</span><br><span class=\"line\">                                            WinnerId -&gt;</span><br><span class=\"line\">                                                <span class=\"keyword\">case</span> check_opponent_over(RaceId, ZoneId, RaceStep, TeamIdA, TeamIdB) of</span><br><span class=\"line\">                                                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                                                        Opponent = try_get_player_race_opponent(RaceId, ZoneId, RaceStep, TeamIdA), </span><br><span class=\"line\"></span><br><span class=\"line\">                                                        game_db:write(Opponent <span class=\"comment\">#player_race_opponent &#123;</span></span><br><span class=\"line\">                                                            winner_id = WinnerId</span><br><span class=\"line\">                                                        &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                                                        game_db:write(<span class=\"comment\">#player_race_member &#123;</span></span><br><span class=\"line\">                                                            race_id   = RaceId,</span><br><span class=\"line\">                                                            zone_id   = ZoneId, </span><br><span class=\"line\">                                                            race_step = NextRace, </span><br><span class=\"line\">                                                            group     = Group, </span><br><span class=\"line\">                                                            index     = Index, </span><br><span class=\"line\">                                                            player_id = WinnerId</span><br><span class=\"line\">                                                        &#125;), </span><br><span class=\"line\"></span><br><span class=\"line\">                                                        race_call(RaceId, race_win, [WinnerId, Group, RaceStep, NextRace]);</span><br><span class=\"line\">                                                    _ -&gt;</span><br><span class=\"line\">                                                        noop</span><br><span class=\"line\">                                                end</span><br><span class=\"line\">                                        end</span><br><span class=\"line\">                                end</span><br><span class=\"line\">                        end</span><br><span class=\"line\">                    end, </span><br><span class=\"line\">                    lists:seq(1, MatchNum)</span><br><span class=\"line\">                )</span><br><span class=\"line\">            end, </span><br><span class=\"line\">            get_all_race_group()</span><br><span class=\"line\">        ), </span><br><span class=\"line\"></span><br><span class=\"line\">        IsOver = check_race_over(RaceId, ZoneId, RaceStep), </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span></span><br><span class=\"line\">            IsOver =:= <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                NowPlayerRace = get_player_race(RaceId, ZoneId), </span><br><span class=\"line\"></span><br><span class=\"line\">                game_db:write(NowPlayerRace <span class=\"comment\">#player_race &#123;</span></span><br><span class=\"line\">                    race_step  = NextStep, </span><br><span class=\"line\">                    race_times = 0, </span><br><span class=\"line\">                    last_time  = lib_misc:get_local_timestamp()</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                noop</span><br><span class=\"line\">        end, </span><br><span class=\"line\"></span><br><span class=\"line\">        IsOver</span><br><span class=\"line\">    end, </span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;atomic, Result&#125; = game_db:<span class=\"keyword\">do</span>(Tran), </span><br><span class=\"line\">    Result.</span><br></pre></td></tr></table></figure></p>\n<p>第五步 出晋级赛战报<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">% 播报战报及通知</span><br><span class=\"line\">deal_receive_beisai_data(RaceStep,IsOver) -&gt;</span><br><span class=\"line\">    Tran = fun() -&gt;</span><br><span class=\"line\">        % write_race_data(RaceReportList,RaceResultList,MemberList,OpponentList, WorldWarList),</span><br><span class=\"line\">        <span class=\"keyword\">if</span>  </span><br><span class=\"line\">            IsOver =:= <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                <span class=\"comment\">#race_step &#123;</span></span><br><span class=\"line\">                    next_step = NextStep</span><br><span class=\"line\">                &#125; = mod_race:get_race_step(RaceStep),</span><br><span class=\"line\">                % return_bet(RaceStep),</span><br><span class=\"line\">                <span class=\"keyword\">if</span></span><br><span class=\"line\">                    RaceStep =:= ?RS_RACE_1 -&gt;</span><br><span class=\"line\">                        % give_award(),给予奖励</span><br><span class=\"line\">                        ZoneId = 0,</span><br><span class=\"line\">                        <span class=\"keyword\">case</span> mod_race:try_get_player_race_member(?RACE_SERVER_WAR, ZoneId, ?RS_RACE_1_OVER, ?RG_TIAN_BANG, 1) of</span><br><span class=\"line\">                            null -&gt;</span><br><span class=\"line\">                                noop;</span><br><span class=\"line\">                            Member -&gt;</span><br><span class=\"line\">                                ServerId   = mod_player:get_player_data(Member <span class=\"comment\">#player_race_member.player_id,server_id),</span></span><br><span class=\"line\">                                ServerName = mod_server:get_server_name(ServerId),</span><br><span class=\"line\">                                NickName   = mod_player:get_player_data(Member <span class=\"comment\">#player_race_member.player_id,nickname),</span></span><br><span class=\"line\">                                api_chat:centre_screen_message_notify(</span><br><span class=\"line\">                                    ?MEST_XIAN_DAO_HUI_GUAN_JUN, </span><br><span class=\"line\">                                    [&#123;ServerName&#125;,&#123;NickName&#125;]</span><br><span class=\"line\">                                )</span><br><span class=\"line\">                        end;</span><br><span class=\"line\">                    <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                        noop</span><br><span class=\"line\">                end,</span><br><span class=\"line\">                mod_server:set_player_server_int_data(?SDT_SERVER_WAR_RACE_STEP, NextStep), </span><br><span class=\"line\">                mod_server:set_player_server_int_data(?SDT_SERVER_WAR_RACE_TIMES, 0),</span><br><span class=\"line\">                mod_timer:close(1,?TIMER_XIAN_DAO_HUI_BEI_SAI);</span><br><span class=\"line\">            <span class=\"literal\">true</span> -&gt;</span><br><span class=\"line\">                noop</span><br><span class=\"line\">        end</span><br><span class=\"line\">    end,</span><br><span class=\"line\">    game_db:<span class=\"keyword\">do</span>(Tran).</span><br><span class=\"line\">    % api_server_war:notify_new_report().</span><br></pre></td></tr></table></figure></p>\n","categories":[],"tags":[{"name":"游戏","slug":"游戏","count":3,"path":"api/tags/游戏.json"}]}